<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure QR Code Scanner</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gray-100 px-4 py-8">
<div class="w-full max-w-lg bg-white shadow-lg rounded-lg p-6">
    <h1 class="text-2xl font-bold text-center mb-4">Secure QR Scanner</h1>
    
    <!-- Location Status -->
    <div id="location-status" class="mb-4 p-3 bg-yellow-100 rounded-lg text-center">
        Waiting for location access...
    </div>

    <!-- QR Code Scanner Container -->
    <div id="qr-reader" class="w-full h-[320px] rounded-lg border-2 border-gray-300"></div>

    <!-- Loading Animation -->
    <div id="loading" class="hidden text-center mt-4">
        <p class="text-lg font-semibold">Validating...</p>
        <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mt-2"></div>
    </div>

    <!-- Result Container -->
    <div id="result-container" class="hidden mt-4">
        <p class="text-lg font-semibold text-center">Scan Result:</p>
        <div id="qr-result" class="mt-2 p-3 rounded-md break-words"></div>
    </div>
</div>

<script>
// Encryption key - should be same as the one used to generate QR codes
const ENCRYPTION_KEY = 'your-secret-key-here';

// Target coordinates (41°06'13.0"N 80°38'56.7"W)
const TARGET_LOCATION = {
    lat: 41.103611,
    lng: -80.649083
};

// Maximum allowed distance in meters
const MAX_DISTANCE = 100;

// Convert DMS to decimal degrees
function dmsToDecimal(degrees, minutes, seconds, direction) {
    let decimal = degrees + (minutes / 60) + (seconds / 3600);
    if (direction === 'S' || direction === 'W') {
        decimal = -decimal;
    }
    return decimal;
}

// Calculate distance between two points using Haversine formula
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Earth's radius in meters
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
        Math.cos(φ1) * Math.cos(φ2) *
        Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return R * c;
}

// Decrypt QR data
function decryptData(encryptedData) {
    try {
        const bytes = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY);
        return bytes.toString(CryptoJS.enc.Utf8);
    } catch (error) {
        return null;
    }
}

let currentPosition = null;
let qrScanner = new Html5Qrcode("qr-reader");
let isScanning = true;

// Request location access
navigator.geolocation.watchPosition(
    (position) => {
        currentPosition = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };
        const distance = calculateDistance(
            currentPosition.lat,
            currentPosition.lng,
            TARGET_LOCATION.lat,
            TARGET_LOCATION.lng
        );
        const locationStatus = document.getElementById('location-status');
        if (distance <= MAX_DISTANCE) {
            locationStatus.className = 'mb-4 p-3 bg-green-100 rounded-lg text-center';
            locationStatus.textContent = 'Location verified ✓';
        } else {
            locationStatus.className = 'mb-4 p-3 bg-red-100 rounded-lg text-center';
            locationStatus.textContent = `Too far from target location (${Math.round(distance)}m away)`;
        }
    },
    (error) => {
        document.getElementById('location-status').innerHTML = 
            'Error accessing location. Please enable location services.';
    },
    { enableHighAccuracy: true }
);

function onScanSuccess(decodedText) {
    if (!isScanning || !currentPosition) return;
    isScanning = false;
    
    document.getElementById('loading').classList.remove('hidden');
    
    // Try to decrypt the QR code data
    const decryptedData = decryptData(decodedText);
    if (!decryptedData) {
        showResult('Invalid QR code format', 'bg-red-100 text-red-700');
        return;
    }

    // Calculate distance from target
    const distance = calculateDistance(
        currentPosition.lat,
        currentPosition.lng,
        TARGET_LOCATION.lat,
        TARGET_LOCATION.lng
    );

    qrScanner.stop().then(() => {
        setTimeout(() => {
            document.getElementById('loading').classList.add('hidden');
            
            if (distance <= MAX_DISTANCE) {
                showResult('Valid QR code scanned: ' + decryptedData, 'bg-green-100 text-green-700');
            } else {
                showResult(`Too far from target location (${Math.round(distance)}m away)`, 'bg-red-100 text-red-700');
            }
        }, 1500);
    });
}

function showResult(message, className) {
    const container = document.getElementById('result-container');
    const result = document.getElementById('qr-result');
    container.classList.remove('hidden');
    result.className = `mt-2 p-3 rounded-md break-words ${className}`;
    result.textContent = message;
}

function onScanError(errorMessage) {
    console.warn(errorMessage);
}

// Start scanning
qrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 300 },
    onScanSuccess,
    onScanError
);
</script>
</body>
</html>