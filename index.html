<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium QR Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen text-white">
    <!-- Location Permission Modal -->
    <div id="permission-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white text-gray-800 rounded-xl p-8 max-w-md mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold mb-4">Location Access Required</h2>
            <p class="mb-6">This app needs your location to verify your presence at the designated spot. Please allow location access to continue.</p>
            <button onclick="requestLocationPermission()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                Allow Location Access
            </button>
        </div>
    </div>

    <!-- Main Content (Hidden initially) -->
    <main id="main-content" class="hidden">
        <div class="container mx-auto px-4 py-8 max-w-xl">
            <!-- Status Bar -->
            <div class="mb-6">
                <div id="location-status" class="bg-gray-800 rounded-lg p-4 flex items-center justify-between">
                    <span class="flex items-center">
                        <div id="status-indicator" class="w-3 h-3 rounded-full bg-yellow-400 mr-3"></div>
                        <span id="status-text">Checking location...</span>
                    </span>
                    <span id="distance-text" class="text-sm text-gray-400"></span>
                </div>
            </div>

            <!-- Scanner Container -->
            <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                <h1 class="text-2xl font-bold mb-6 text-center">Premium QR Scanner</h1>
                
                <div id="qr-reader" class="rounded-lg overflow-hidden mb-6"></div>

                <!-- Loading Animation -->
                <div id="loading" class="hidden">
                    <div class="flex flex-col items-center justify-center p-4">
                        <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <p class="mt-4 text-gray-300">Validating location and QR code...</p>
                    </div>
                </div>

                <!-- Result Container -->
                <div id="result-container" class="hidden">
                    <div id="qr-result" class="rounded-lg p-4 text-center"></div>
                </div>
            </div>
        </div>
    </main>

<script>
const ENCRYPTION_KEY = 'your-secret-key-here';
const GOOGLE_FORM_URL = 'https://forms.google.com/your-form-url';
const TARGET_LOCATION = {
    lat: 41.103611,
    lng: -80.649083
};
const MAX_DISTANCE = 20; // 20 meters radius

let currentPosition = null;
let qrScanner = null;
let isScanning = true;

// Session handling
function saveToSession(data) {
    const sessionData = {
        timestamp: new Date().toISOString(),
        location: currentPosition,
        decodedData: data
    };
    sessionStorage.setItem('qrScanData', JSON.stringify(sessionData));
}

// Location handling
function updateLocationStatus(position) {
    currentPosition = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
    };

    const distance = calculateDistance(
        currentPosition.lat,
        currentPosition.lng,
        TARGET_LOCATION.lat,
        TARGET_LOCATION.lng
    );

    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const distanceText = document.getElementById('distance-text');

    if (distance <= MAX_DISTANCE) {
        statusIndicator.className = 'w-3 h-3 rounded-full bg-green-400 mr-3';
        statusText.textContent = 'Location verified';
        distanceText.textContent = `${Math.round(distance)}m from target`;
    } else {
        statusIndicator.className = 'w-3 h-3 rounded-full bg-red-400 mr-3';
        statusText.textContent = 'Out of range';
        distanceText.textContent = `${Math.round(distance)}m from target`;
    }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
        Math.cos(φ1) * Math.cos(φ2) *
        Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return R * c;
}

function decryptData(encryptedData) {
    try {
        const bytes = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY);
        return bytes.toString(CryptoJS.enc.Utf8);
    } catch (error) {
        return null;
    }
}

function showResult(message, type) {
    const container = document.getElementById('result-container');
    const result = document.getElementById('qr-result');
    container.classList.remove('hidden');
    
    const bgColor = type === 'success' ? 'bg-green-900' : 'bg-red-900';
    result.className = `rounded-lg p-4 text-center ${bgColor}`;
    result.textContent = message;
}

function requestLocationPermission() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                document.getElementById('permission-modal').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                initializeScanner();
                
                // Start watching position
                navigator.geolocation.watchPosition(
                    updateLocationStatus,
                    (error) => {
                        showResult('Error tracking location. Please refresh and try again.', 'error');
                    },
                    { enableHighAccuracy: true }
                );
            },
            (error) => {
                alert('Location access is required for this app to work. Please enable location services and refresh the page.');
            }
        );
    } else {
        alert('Geolocation is not supported by your browser.');
    }
}

function onScanSuccess(decodedText) {
    if (!isScanning || !currentPosition) return;
    isScanning = false;
    
    document.getElementById('loading').classList.remove('hidden');
    
    const decryptedData = decryptData(decodedText);
    if (!decryptedData) {
        showResult('Invalid QR code format', 'error');
        isScanning = true;
        return;
    }

    const distance = calculateDistance(
        currentPosition.lat,
        currentPosition.lng,
        TARGET_LOCATION.lat,
        TARGET_LOCATION.lng
    );

    qrScanner.stop().then(() => {
        setTimeout(() => {
            document.getElementById('loading').classList.add('hidden');
            
            if (distance <= MAX_DISTANCE) {
                saveToSession(decryptedData);
                showResult('Success! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = GOOGLE_FORM_URL;
                }, 1500);
            } else {
                showResult(`You must be within ${MAX_DISTANCE}m of the target location`, 'error');
                isScanning = true;
                initializeScanner();
            }
        }, 1500);
    });
}

function initializeScanner() {
    if (qrScanner) {
        qrScanner.clear();
    }
    
    qrScanner = new Html5Qrcode("qr-reader");
    qrScanner.start(
        { facingMode: "environment" },
        {
            fps: 10,
            qrbox: { width: 250, height: 250 },
        },
        onScanSuccess,
        (error) => {
            // Suppress error logging for better UX
        }
    );
}
</script>
</body>
</html>