<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AttendForum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 h-screen overflow-hidden flex items-center justify-center">
    <!-- Location Permission Modal -->
    <div id="permission-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white text-gray-800 rounded-xl p-8 max-w-md mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold mb-4">Location Access Required</h2>
            <p class="mb-6">Please allow location access to verify your attendance.</p>
            <button onclick="requestLocationPermission()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                Allow Location Access
            </button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white text-gray-800 rounded-xl p-8 max-w-md mx-4 shadow-2xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold mb-4">Attendance Marked</h2>
                <p class="mb-6">Your attendance has been marked as Present successfully.</p>
                <button onclick="downloadAttendanceLog()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors mb-3">
                    Download Attendance Log
                </button>
                <button onclick="closeSuccessModal()" class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="hidden w-full max-w-md px-4">
        <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
            <h1 class="text-3xl font-bold mb-8 text-center text-white">AttendForum</h1>
            
            <div id="qr-reader" class="rounded-lg overflow-hidden mb-6"></div>

            <!-- Loading Animation -->
            <div id="loading" class="hidden">
                <div class="flex flex-col items-center justify-center p-4">
                    <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <p class="mt-4 text-gray-300">Verifying attendance...</p>
                </div>
            </div>

            <!-- Result Container -->
            <div id="result-container" class="hidden">
                <div id="qr-result" class="rounded-lg p-4 text-center"></div>
            </div>
        </div>
    </main>

<script>
// Configuration
const ENCRYPTION_KEY = 'your-secure-key-123'; // Replace with your secret key
const API_ENDPOINT = 'https://api.example.com/attendance';
const TARGET_LOCATION = {
    lat: 41.103611,
    lng: -80.649083
};
const MAX_DISTANCE = 20; // meters

// Global variables
let currentPosition = null;
let qrScanner = null;
let isScanning = true;
let lastAttendanceLog = null;

// Mock API call
async function markAttendance(data) {
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve({
                success: true,
                message: "Attendance marked successfully",
                timestamp: new Date().toISOString(),
                verificationKey: CryptoJS.SHA256(data).toString()
            });
        }, 1000);
    });
}

function downloadAttendanceLog() {
    if (!lastAttendanceLog) {
        alert('No attendance data available to download.');
        return;
    }

    const content = `Attendance Verification Log\n` +
        `================================\n` +
        `Timestamp: ${lastAttendanceLog.timestamp}\n` +
        `QR Code Content: ${lastAttendanceLog.qrDecodedText}\n\n` +
        `Location Verification\n` +
        `----------------------\n` +
        `Your Coordinates: ${lastAttendanceLog.userCoordinates.lat.toFixed(6)}, ${lastAttendanceLog.userCoordinates.lng.toFixed(6)}\n` +
        `Professor Coordinates: ${lastAttendanceLog.professorCoordinates.lat.toFixed(6)}, ${lastAttendanceLog.professorCoordinates.lng.toFixed(6)}\n` +
        `Distance Between: ${lastAttendanceLog.distance.toFixed(2)} meters\n` +
        `Within Safe Distance: ${lastAttendanceLog.isSafeDistance ? 'YES' : 'NO'}\n\n` +
        `Security Information\n` +
        `---------------------\n` +
        `Verification Key: ${lastAttendanceLog.verificationKey}\n` +
        `Data Signature: ${lastAttendanceLog.signature}\n`;

    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `attendance_log_${lastAttendanceLog.timestamp.replace(/[:.]/g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function showSuccessModal() {
    document.getElementById('success-modal').classList.remove('hidden');
    document.getElementById('success-modal').classList.add('flex');
}

function closeSuccessModal() {
    document.getElementById('success-modal').classList.add('hidden');
    document.getElementById('success-modal').classList.remove('flex');
    window.location.reload();
}

function decryptData(encryptedData) {
    try {
        const parsedData = encryptedData.replace(/-/g, '+').replace(/_/g, '/');
        const bytes = CryptoJS.AES.decrypt(parsedData, ENCRYPTION_KEY);
        return bytes.toString(CryptoJS.enc.Utf8) || encryptedData;
    } catch (error) {
        return encryptedData;
    }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

async function processAttendance(decryptedData) {
    const timestamp = new Date().toISOString();
    const distance = calculateDistance(
        currentPosition.lat,
        currentPosition.lng,
        TARGET_LOCATION.lat,
        TARGET_LOCATION.lng
    );

    try {
        const response = await markAttendance(decryptedData);
        if (response.success) {
            lastAttendanceLog = {
                timestamp: timestamp,
                qrDecodedText: decryptedData,
                userCoordinates: { 
                    lat: currentPosition.lat,
                    lng: currentPosition.lng 
                },
                professorCoordinates: TARGET_LOCATION,
                distance: distance,
                isSafeDistance: distance <= MAX_DISTANCE,
                verificationKey: response.verificationKey,
                signature: CryptoJS.HmacSHA256(
                    decryptedData + timestamp, 
                    ENCRYPTION_KEY
                ).toString()
            };
            showSuccessModal();
        }
    } catch (error) {
        showResult(`Error: ${error.message}`, 'error');
        isScanning = true;
        initializeScanner();
    }
}

function showResult(message, type) {
    const container = document.getElementById('result-container');
    const result = document.getElementById('qr-result');
    container.classList.remove('hidden');
    
    const bgColor = type === 'success' ? 'bg-green-900' : 'bg-red-900';
    result.className = `rounded-lg p-4 text-center ${bgColor}`;
    result.textContent = message;
}

function requestLocationPermission() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                document.getElementById('permission-modal').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                initializeScanner();
            },
            (error) => {
                alert('Location access is required. Please enable location services.');
            }
        );
    } else {
        alert('Geolocation is not supported by your browser.');
    }
}

function onScanSuccess(decodedText) {
    if (!isScanning || !currentPosition) return;
    
    isScanning = false;
    document.getElementById('loading').classList.remove('hidden');
    
    const decryptedData = decryptData(decodedText);
    if (!decryptedData) {
        showResult('Invalid QR code format', 'error');
        isScanning = true;
        return;
    }

    qrScanner.stop().then(() => {
        processAttendance(decryptedData);
    }).catch(error => {
        showResult('Error processing QR code', 'error');
        isScanning = true;
    });
}

function initializeScanner() {
    if (qrScanner) qrScanner.clear();
    
    qrScanner = new Html5Qrcode("qr-reader");
    qrScanner.start(
        { facingMode: "environment" },
        {
            fps: 10,
            qrbox: { width: 250, height: 250 },
        },
        onScanSuccess,
        () => {} // Suppress error logging
    ).catch(() => {
        showResult('Error starting camera', 'error');
    });
}
</script>
</body>
</html>